name: Run conda-lock to update dependencies

on:
  push:
  workflow_dispatch:
  schedule:
  # At 5am UTC Monday and Thursday
  - cron: 0 5 * * MON,THU

jobs:
  conda-lock:
    defaults:
      run:
        # Ensure the environment is activated
        # <https://github.com/mamba-org/provision-with-micromamba#important>
        shell: bash -l {0}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install Micromamba
      uses: mamba-org/setup-micromamba@v1
      with:
        environment-file: conda-lock.yml
        environment-name: conda-lock-dev

    - name: Install conda-lock from branch
      run: pip install --editable .

    - name: Run conda-lock to recreate lockfile from scratch
      run: |
        rm conda-lock.yml
        conda-lock -f dev-environment.yaml -f pyproject.toml

    - name: Open a pull request
      uses: peter-evans/create-pull-request@v5
      with:
        # # The default GITHUB_TOKEN doesn't allow other workflows to trigger.
        # # Thus if there are tests to be run, they won't be run. For more info,
        # # see the note under
        # # <https://github.com/peter-evans/create-pull-request#action-inputs>.
        # # One possible workaround is to specify a Personal Access Token (PAT).
        # # This PAT should have read-write permissions for "Pull Requests"
        # # and read-write permissions for "Contents".
        # token: ${{ secrets.GH_PAT_FOR_PR }}
        commit-message: Relock dependencies
        title: Relock dependencies
        body: >
          This pull request relocks the dependencies with conda-lock.
        branch: relock-deps
        labels: conda-lock
        delete-branch: true
